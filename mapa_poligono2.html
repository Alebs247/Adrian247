<!DOCTYPE html>
<html>
<head>
    <title>Mapa Interactivo Planefea 2026</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Leaflet Geocoder -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <style>
    body {
        font-family: sans-serif;
        padding: 10px;
        background-color: #f4fdf6; /* Fondo claro tipo ecol√≥gico */
    }

    h2 {
        font-family: 'Quicksand', sans-serif;
        color: #2e7d32; /* Verde natural */
        font-size: 26px;
        text-shadow: 1px 1px 1px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    #weathermap {
        width: 100%;
        height: 500px;
        border: 1px solid #ccc;
        margin-bottom: 10px;
    }

    button, input {
        margin-right: 5px;
        padding: 8px;
    }
</style>

</head>
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@600&display=swap" rel="stylesheet">

<body>

<h2>üó∫Ô∏è Crear pol√≠gono por Problem√°tica Ambiental</h2>

<div id="weathermap"></div>

<input type="text" id="nombrePoligono" placeholder="Nombre del pol√≠gono" />
<button onclick="iniciarNuevoPoligono()">‚ûï Nuevo pol√≠gono</button>
<button onclick="dibujarPoligonoActual()">üî∑ Dibujar</button>
<button onclick="guardarPoligono()">üíæ Guardar</button>
<!-- <button onclick="cargarPoligonos()">üìÇ Cargar guardados</button> -->
<button onclick="borrarMapa()">üóëÔ∏è Borrar mapa</button>

<script>
let mapa;
let verticesActuales = [];
let marcadores = [];
let poligonos = [];

function generarCodigoUnico() {
    return 'ID-' + Date.now().toString(36) + '-' + Math.random().toString(36).substring(2, 8).toUpperCase();
}

const capaOSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '¬© OpenStreetMap'
});

const capaEsri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles ¬© Esri & the GIS User Community',
    maxZoom: 19
});

function iniciarNuevoPoligono() {
    verticesActuales = [];
    marcadores = [];
    poligonos = [];

    document.getElementById('weathermap').innerHTML = "<div id='map' style='width: 100%; height: 100%;'></div>";

    mapa = L.map('map', {
        center: [0, 0],
        zoom: 2,
        layers: [capaEsri]
    });

    const capasBase = {
        "üõ∞Ô∏è Esri Sat√©lite": capaEsri,
        "üó∫Ô∏è OpenStreetMap": capaOSM
    };

    L.control.layers(capasBase).addTo(mapa);

    // Geocoder
    L.Control.geocoder({ defaultMarkGeocode: true }).addTo(mapa);

    mapa.on('click', function(e) {
        const latlng = e.latlng;
        verticesActuales.push(latlng);
        const marker = L.marker(latlng).addTo(mapa);
        marcadores.push(marker);
    });
}

function dibujarPoligonoActual() {
    if (verticesActuales.length < 3) {
        alert("Selecciona al menos 3 puntos.");
        return;
    }

    const poligono = L.polygon(verticesActuales, {
        color: 'green',
        fillColor: 'lightgreen',
        fillOpacity: 0.5
    }).addTo(mapa);

    poligonos.push(poligono);
    mapa.fitBounds(poligono.getBounds());
    poligono.bindPopup("Pol√≠gono actual.");
}

function guardarPoligono() {
    const nombre = document.getElementById('nombrePoligono').value.trim();
    if (!nombre) {
        alert("Escribe un nombre para el pol√≠gono.");
        return;
    }
    if (verticesActuales.length < 3) {
        alert("El pol√≠gono necesita al menos 3 puntos.");
        return;
    }

    const confirmar = confirm(`¬øEst√°s seguro de que quieres guardar el pol√≠gono "${nombre}"?`);
    if (!confirmar) {
        alert("‚ùå Guardado cancelado.");
        return;
    }

    const codigoUnico = generarCodigoUnico();

    const data = {
        codigo: codigoUnico,
        nombre: nombre,
        vertices: verticesActuales
    };

    fetch('https://script.google.com/macros/s/AKfycbzwt2_DYPbt9HXwAR8qAdx09-pJeONCnn-i-nHreDSmAMgHl_2ziUEGzmuDA8GWHyT-9A/exec', {
        method: 'POST',
        mode: 'no-cors',
        body: JSON.stringify(data),
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(() => {
        alert(`‚úÖ Pol√≠gono guardado con c√≥digo: ${codigoUnico}`);
        document.getElementById('nombrePoligono').value = '';
        verticesActuales = [];
    })
    .catch(err => {
        console.error(err);
        alert("‚ùå Error al conectar con Google Sheets.");
    });
}

function cargarPoligonos() {
    const guardados = JSON.parse(localStorage.getItem('poligonos'));
    if (!guardados || guardados.length === 0) {
        alert("No hay pol√≠gonos guardados localmente.");
        return;
    }

    document.getElementById('weathermap').innerHTML = "<div id='map' style='width: 100%; height: 100%;'></div>";

    const mapCarga = L.map('map', {
        center: [0, 0],
        zoom: 2,
        layers: [capaEsri]
    });

    const capasBase = {
        "üõ∞Ô∏è Esri Sat√©lite": capaEsri,
        "üó∫Ô∏è OpenStreetMap": capaOSM
    };

    L.control.layers(capasBase).addTo(mapCarga);

    guardados.forEach((poly) => {
        const poligono = L.polygon(poly.vertices, {
            color: 'blue',
            fillColor: 'skyblue',
            fillOpacity: 0.4
        }).addTo(mapCarga);
        poligono.bindPopup(`Pol√≠gono: ${poly.nombre}`);
    });
}

function borrarMapa() {
    marcadores.forEach(m => mapa.removeLayer(m));
    poligonos.forEach(p => mapa.removeLayer(p));
    marcadores = [];
    poligonos = [];
    verticesActuales = [];
    alert("üßπ Mapa limpio.");
}
</script>

</body>
</html>
